---
import Layout from "../../layouts/Layout.astro";
import info from "../../info.json";
import { toFraction } from "../../utilts";
import { BASE_URL } from "../../consts";
import { Image } from "astro:assets";

interface Props {
  src: string;
  about: string;
}

export function getStaticPaths() {
  return Object.entries(info.pages)
    .map(([page, pageInfo]) => {
      const { assets, photos } = pageInfo;

      const assetPaths = Object.entries(assets).map(([key, { src }]) => ({
        params: {
          page,
          key: `assets-${key}`,
        },
        props: {
          src,
        },
      }));

      const photoPaths = Object.entries(photos).map(([key, photo]) => ({
        params: {
          page,
          key,
        },
        props: {
          src: photo.src,
          about: `${photo.make} ${photo.model} / ISO ${photo.iso} / f${
            photo.f_stop
          } / ${photo.focal_length}mm / ${toFraction(photo.exposure_time)}s`,
        },
      }));

      return [...assetPaths, ...photoPaths];
    })
    .flat();
}

const { page, key } = Astro.params;
const { src, about } = Astro.props;

const pageKey = key.replace("assets/", "").replace("assets-", "");
const pageInfo = info.pages?.[page as keyof typeof info.pages];
const photoInfo =
  pageInfo?.photos?.[pageKey as keyof typeof pageInfo.photos] ||
  pageInfo?.assets?.[pageKey as keyof typeof pageInfo.assets];
if (!photoInfo) {
  throw new Error(`Photo or asset not found: ${page} - ${key}`);
}
const dimensions = photoInfo?.dimensions;

const ext = src.split(".")[1];

const imgSrc = `${BASE_URL}/${page}/${key.replace("assets-", "assets/")}.${ext}`;
---

<Layout title={`${page} - ${key}`}>
  <main>
    <Image
      src={imgSrc}
      alt={key}
      width={dimensions?.width}
      height={dimensions?.height}
    />
    {about && <p>{about}</p>}
  </main>
</Layout>

<style is:global>
  main {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
    background-color: black;
    color: rgba(255, 255, 255, 0.6);
  }

  img {
    margin: 0 auto;
    height: auto;
    width: auto;
    max-height: 80vh;
    max-width: 80vw;
  }
  p {
    margin: 1rem 1rem;
    text-align: center;
  }
</style>
